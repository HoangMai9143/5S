@using DC.Models
@inject AppDbContext appDbContext
@inject ISnackbar sb

@rendermode InteractiveServer

<MudDialog>
  <DialogContent>
    <MudStack>
      <MudDateRangePicker @bind-DateRange="_dateRange" Margin="Margin.Dense" PlaceholderStart="Start Date" PlaceholderEnd="End Date" MinDate="@DateTime.Today.AddYears(-1)" MaxDate="@DateTime.Today.AddYears(1)" />
      <MudSwitch @bind-Value="_isActive" Color="Color.Success" UncheckedColor="Color.Error">Is Active</MudSwitch>
    </MudStack>
  </DialogContent>
  <DialogActions>
    <MudButton OnClick="Cancel">Cancel</MudButton>
    <MudButton Color="Color.Primary" OnClick="Submit">Save</MudButton>
  </DialogActions>
</MudDialog>

@code {
  [CascadingParameter] MudDialogInstance MudDialog { get; set; }
  [Parameter] public SurveyModel Survey { get; set; }

  private DateRange _dateRange;
  private bool _isActive;

  protected override void OnInitialized()
  {
    _dateRange = new DateRange(Survey.StartDate, Survey.EndDate);
    _isActive = Survey.IsActive;
  }

  private void Cancel()
  {
    MudDialog.Cancel();
  }

  private async Task Submit()
  {
    if (_dateRange.Start.HasValue && _dateRange.End.HasValue)
    {
      if (_dateRange.Start.Value > _dateRange.End.Value)
      {
        sb.Add("End date must be after start date", Severity.Error);
        return;
      }

      Survey.StartDate = _dateRange.Start.Value;
      Survey.EndDate = _dateRange.End.Value;
      Survey.IsActive = _isActive;

      if (Survey.EndDate < DateTime.Today)
      {
        Survey.IsActive = false;
      }

      try
      {
        appDbContext.Set<SurveyModel>().Update(Survey);
        await appDbContext.SaveChangesAsync();
        MudDialog.Close(DialogResult.Ok(true));
      }
      catch (Exception ex)
      {
        sb.Add($"Error updating survey: {ex.Message}", Severity.Error);
      }
    }
    else
    {
      sb.Add("Please select both start and end dates", Severity.Warning);
    }
  }
}